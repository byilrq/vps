#!/bin/bash
##
## 自动化安装 Ubuntu 和 Debian 系统
## 支持网络自动安装，无需人工干预
## 默认 root 密码: LeitboGi0ro
## 修改者: 秋水逸冰
## 博客: https://teddysun.com/
## 修改者: airium
## GitHub: https://github.com/airium
## 汉化与优化: AI助手
## 说明: 本脚本仅支持 Ubuntu 和 Debian 系统安装

# 颜色定义
下划线='\033[4m'
青色='\033[36m'
蓝色='\033[34m'
黄色='\033[33m'
绿色='\033[32m'
红色='\033[31m'
原色='\033[0m'

export tmpVER=''
export tmpDIST=''
export tmpURL=''
export tmpWORD=''
export tmpMirror=''
export tmpDHCP=''
export targetRelese=''
export targetLang='zh_CN.UTF-8'
export TimeZone=''
export setIpStack=''
export ipAddr=''
export ipMask=''
export ipGate=''
export ipDNS='8.8.8.8 1.1.1.1'
export ip6Addr=''
export ip6Mask=''
export ip6Gate=''
export ip6DNS='2001:4860:4860::8888 2606:4700:4700::1111'
export IncDisk=''
export interface=''
export interfaceSelect=''
export setInterfaceName='0'
export autoPlugAdapter='1'
export IsCN=''
export Relese=''
export sshPORT=''
export ddMode='0'
export setNet='0'
export setNetbootXyz='0'
export setRDP='0'
export tmpSetIPv6=''
export setIPv6='1'
export setRaid=''
export setDisk=''
export swapSpace='0'
export partitionTable='mbr'
export fileSystem=''
export setMemCheck='1'
export setCloudKernel=''
export enableBBR='0'
export isMirror='0'
export FindDists='0'
export setFileType=''
export loaderMode='0'
export setMotd='1'
export setDns='1'
export LANG="zh_CN.UTF-8"
export LANGUAGE="zh_CN:zh"
export IncFirmware='0'
export SpikCheckDIST='0'
export UNKNOWHW='0'
export UNVER='6.4'
export GRUBDIR=''
export GRUBFILE=''
export GRUBVER=''
export VER=''
export setCMD=""
export setConsole=''
export setFail2ban='1'
export setAutoConfig='1'
export FirmwareImage=''
export AddNum='1'
export DebianModifiedProcession=''

# 参数解析
while [[ $# -ge 1 ]]; do
    case $1 in
        -debian | -Debian)
            shift
            Relese='Debian'
            tmpDIST="$1"
            shift
            ;;
        -ubuntu | -Ubuntu)
            shift
            Relese='Ubuntu'
            tmpDIST="$1"
            shift
            ;;
        -architecture)
            shift
            tmpVER="$1"
            shift
            ;;
        -lang | -language)
            shift
            targetLang="$1"
            shift
            ;;
        --ip-addr)
            shift
            ipAddr="$1"
            shift
            ;;
        --ip-mask)
            shift
            ipMask="$1"
            shift
            ;;
        --ip-gate)
            shift
            ipGate="$1"
            shift
            ;;
        --ip-dns)
            shift
            ipDNS="$1"
            ipDNSChanged='1'
            shift
            ;;
        --network)
            shift
            tmpDHCP="$1"
            shift
            ;;
        --adapter)
            shift
            interfaceSelect="$1"
            shift
            ;;
        -mirror)
            shift
            isMirror='1'
            tmpMirror="$1"
            shift
            ;;
        -setdisk)
            shift
            setDisk="$1"
            shift
            ;;
        -swap | -virtualmemory)
            shift
            setSwap="$1"
            shift
            ;;
        -partition)
            shift
            partitionTable="$1"
            shift
            ;;
        -filesystem)
            shift
            setFileSystem="$1"
            shift
            ;;
        -timezone)
            shift
            TimeZone="$1"
            shift
            ;;
        -cmd)
            shift
            setCMD="$1"
            shift
            ;;
        -port)
            shift
            sshPORT="$1"
            shift
            ;;
        -pwd | -password)
            shift
            tmpWORD="$1"
            shift
            ;;
        -hostname)
            shift
            tmpHostName="$1"
            shift
            ;;
        --bbr)
            shift
            enableBBR="1"
            ;;
        --allbymyself)
            shift
            setAutoConfig='0'
            ;;
        --nomemcheck)
            shift
            setMemCheck='0'
            ;;
        *)
            if [[ "$1" != 'error' ]]; then echo -ne "\n无效选项: '$1'\n\n"; fi
            echo -ne " 使用方法:\n\tbash $(basename $0)\t-debian          [${下划线}${黄色}版本名称${原色}]\n\t\t\t\t-ubuntu          [${下划线}版本名称${原色}]\n\t\t\t\t-architecture    [32/i386|64/${下划线}${黄色}amd64${原色}|arm/${下划线}${黄色}arm64${原色}]\n\t\t\t\t--ip-addr/--ip-gate/--ip-mask\n\t\t\t\t-mirror          [镜像地址]\n\t\t\t\t-pwd             [Linux密码]\n\t\t\t\t-port            [SSH端口]\n"
            exit 1
            ;;
    esac
done

# 检查 Root 权限
[[ "$EUID" -ne '0' || $(id -u) != '0' ]] && echo -ne "\n[${红色}错误${原色}] 此脚本必须以 root 权限执行！\n\n请尝试:\n${黄色}sudo -s\n${原色}\n然后执行:\n${黄色}cd ~ && bash $(basename $0)\n\n" && exit 1

# 检查网络连通性（判断是否在中国）
function checkCN() {
    echo -ne "\n${青色}# 检查网络位置${原色}\n"
    local pingResult
    if ping -c 2 -W 2 google.com &>/dev/null; then
        pingResult="成功"
        IsCN=""
    else
        pingResult="失败"
        IsCN="cn"
    fi
    echo -ne "[${绿色}完成${原色}] 网络检查: $pingResult\n"
    if [[ "$IsCN" == "cn" ]]; then
        echo -ne "[${黄色}提示${原色}] 检测到中国大陆网络环境，将使用国内镜像源\n"
        [[ "$ipDNSChanged" != "1" ]] && ipDNS="119.29.29.29 223.6.6.6"
        [[ "$ip6DNSChanged" != "1" ]] && ip6DNS="2402:4e00:: 2400:3200::1"
    fi
}

# 检查系统依赖
function dependence() {
    echo -ne "\n${青色}# 检查系统依赖${原色}\n"
    local Full='0'
    for BIN_DEP in $(echo "$1" | sed 's/,/\n/g'); do
        if [[ -n "$BIN_DEP" ]]; then
            Found='0'
            for BIN_PATH in $(echo "$PATH" | sed 's/:/\n/g'); do
                ls $BIN_PATH/$BIN_DEP >/dev/null 2>&1
                if [ $? == '0' ]; then
                    Found='1'
                    break
                fi
            done
            if [ "$Found" == '1' ]; then
                echo -en "[${绿色}已安装${原色}]\t"
            else
                Full='1'
                echo -en "[${红色}未安装${原色}]"
            fi
            echo -en "\t$BIN_DEP\n"
        fi
    done
    if [ "$Full" == '1' ]; then
        echo -ne "\n[${红色}错误${原色}] 请使用 '${黄色}apt-get${原色}' 或 '${黄色}yum/dnf${原色}' 安装缺失的依赖\n\n"
        exit 1
    fi
    echo -ne "[${绿色}完成${原色}] 所有依赖已满足\n"
}

# 选择镜像源
function selectMirror() {
    [ $# -ge 3 ] || exit 1
    local Relese=$(echo "$1" | sed -r 's/(.*)/\L\1/')
    local DIST=$(echo "$2" | sed 's/\ //g' | sed -r 's/(.*)/\L\1/')
    local VER=$(echo "$3" | sed 's/\ //g' | sed -r 's/(.*)/\L\1/')
    local New=$(echo "$4" | sed 's/\ //g')
    [ -n "$Relese" ] && [ -n "$DIST" ] && [ -n "$VER" ] || exit 1
    
    local TEMP=""
    if [[ "$Relese" == "debian" ]] || [[ "$Relese" == "ubuntu" ]]; then
        [[ "$DIST" == "focal" ]] && legacy="legacy-" || legacy=""
        TEMP="SUB_MIRROR/dists/${DIST}/main/installer-${VER}/current/${legacy}images/netboot/${Relese}-installer/${VER}/initrd.gz"
    fi
    
    [ -n "$TEMP" ] || exit 1
    local mirrorStatus=0
    declare -A MirrorBackup
    
    if [[ "$IsCN" == "cn" ]]; then
        MirrorBackup=(
            ["debian0"]="" 
            ["debian1"]="https://mirrors.tuna.tsinghua.edu.cn/debian"
            ["debian2"]="https://mirrors.aliyun.com/debian"
            ["debian3"]="http://mirrors.163.com/debian"
            ["ubuntu0"]=""
            ["ubuntu1"]="https://mirrors.tuna.tsinghua.edu.cn/ubuntu"
            ["ubuntu2"]="https://mirrors.aliyun.com/ubuntu"
            ["ubuntu3"]="http://mirrors.163.com/ubuntu"
        )
    else
        MirrorBackup=(
            ["debian0"]=""
            ["debian1"]="http://deb.debian.org/debian"
            ["debian2"]="http://archive.debian.org/debian"
            ["ubuntu0"]=""
            ["ubuntu1"]="http://archive.ubuntu.com/ubuntu"
            ["ubuntu2"]="http://ports.ubuntu.com"
        )
    fi
    
    [[ "$New" =~ ^http://|^https://|^ftp:// ]] && MirrorBackup["${Relese}0"]="${New%*/}"
    
    for mirror in $(echo "${!MirrorBackup[@]}" | sed 's/\ /\n/g' | sort -n | grep "^$Relese"); do
        local Current="${MirrorBackup[$mirror]}"
        [ -n "$Current" ] || continue
        local MirrorURL=$(echo "$TEMP" | sed "s#SUB_MIRROR#${Current}#g")
        echo -ne "测试镜像: ${Current}... "
        if wget --no-check-certificate --spider --timeout=3 -o /dev/null "$MirrorURL" 2>/dev/null; then
            echo -ne "[${绿色}可用${原色}]\n"
            mirrorStatus=1
            echo "$Current"
            return 0
        else
            echo -ne "[${红色}不可用${原色}]\n"
        fi
    done
    
    [ $mirrorStatus -eq 1 ] && return 0 || {
        echo -ne "\n[${红色}错误${原色}] 所有镜像源都不可用！\n"
        exit 1
    }
}

# 获取 IPv4 地址
function getIPv4Address() {
    echo -ne "\n${青色}# 获取网络配置${原色}\n"
    
    # 获取所有接口
    local allInterfaces=$(ip -4 addr show | grep -v "lo\|docker\|virbr" | grep "inet" | awk '{print $NF}' | tr '\n' ' ')
    if [[ -z "$allInterfaces" ]]; then
        echo -ne "[${红色}错误${原色}] 未找到可用的网络接口！\n"
        exit 1
    fi
    
    # 选择第一个非本地回环接口
    interface=$(echo $allInterfaces | awk '{print $1}')
    
    # 获取 IP 信息
    ipAddr=$(ip -4 addr show $interface | grep "inet" | awk '{print $2}' | cut -d'/' -f1 | head -n1)
    ipPrefix=$(ip -4 addr show $interface | grep "inet" | awk '{print $2}' | cut -d'/' -f2 | head -n1)
    ipMask=$(netmask "$ipPrefix")
    
    # 获取网关
    ipGate=$(ip -4 route | grep default | grep $interface | awk '{print $3}' | head -n1)
    if [[ -z "$ipGate" ]]; then
        ipGate=$(ip -4 route | grep default | awk '{print $3}' | head -n1)
    fi
    
    echo -ne "[${绿色}完成${原色}] 网络接口: $interface\n"
    echo -ne "[${绿色}完成${原色}] IP地址: $ipAddr\n"
    echo -ne "[${绿色}完成${原色}] 子网掩码: $ipMask\n"
    echo -ne "[${绿色}完成${原色}] 网关: $ipGate\n"
    
    [[ -z "$ipAddr" || -z "$ipMask" || -z "$ipGate" ]] && {
        echo -ne "\n[${红色}错误${原色}] 无法获取完整的网络配置！\n"
        exit 1
    }
}

# 子网掩码计算
function netmask() {
    local n="${1:-32}"
    local b=""
    local m=""
    
    for ((i = 0; i < 32; i++)); do
        [ $i -lt $n ] 2>/dev/null && b="${b}1" || b="${b}0"
    done
    
    for ((i = 0; i < 4; i++)); do
        local s=$(echo "$b" | cut -c$(($(($i * 8)) + 1))-$(($(($i + 1)) * 8)))
        [ "$m" == "" ] && m="$((2#${s}))" || m="${m}.$((2#${s}))"
    done
    echo "$m"
}

# 获取磁盘信息
function getDisk() {
    echo -ne "\n${青色}# 获取磁盘信息${原色}\n"
    
    # 获取根分区
    local rootPart=$(lsblk -ip | grep -v "fd[0-9]*\|sr[0-9]*\|ram[0-9]*\|loop[0-9]*" | sed 's/[[:space:]]*$//g' | grep -w "part /" | head -n 1 | cut -d' ' -f1 | sed 's/..//')
    
    if [[ -n "$rootPart" ]]; then
        local diskSuffix=${rootPart: -4}
        [[ -n $(echo $diskSuffix | grep -o "[0-9]p[0-9]") ]] && IncDisk=$(echo $rootPart | sed 's/p[0-9]*.$//') || IncDisk=$(echo $rootPart | sed 's/[0-9]*.$//')
    else
        IncDisk=$(lsblk -ip | grep -v "fd[0-9]*\|sr[0-9]*\|ram[0-9]*\|loop[0-9]*" | sed 's/[[:space:]]*$//g' | grep -w "disk" | head -n 1 | cut -d' ' -f1)
    fi
    
    [[ -z "$IncDisk" ]] && IncDisk="/dev/sda"
    
    # 获取所有磁盘
    AllDisks=""
    for Count in $(lsblk -ipd | grep -v "fd[0-9]*\|sr[0-9]*\|ram[0-9]*\|loop[0-9]*" | sed 's/[[:space:]]*$//g' | grep -w "disk" | cut -d' ' -f1); do
        AllDisks+="$Count "
    done
    AllDisks=$(echo "$AllDisks" | sed 's/.$//')
    disksNum=$(echo $AllDisks | grep -o "/dev/*" | wc -l)
    
    # 用户手动指定磁盘
    [[ -n "$1" && "$1" != "all" ]] && {
        [[ "$1" =~ "/dev/" ]] && IncDisk="$1" || IncDisk="/dev/$1"
    }
    
    echo -ne "[${绿色}完成${原色}] 系统磁盘: $IncDisk\n"
    echo -ne "[${绿色}完成${原色}] 所有磁盘: $AllDisks\n"
    echo -ne "[${绿色}完成${原色}] 磁盘数量: $disksNum\n"
}

# 获取时区
function getUserTimeZone() {
    echo -ne "\n${青色}# 获取时区${原色}\n"
    
    if [[ ! "$TimeZone" =~ ^[a-zA-Z] ]]; then
        if [[ "$IsCN" == "cn" ]]; then
            TimeZone="Asia/Shanghai"
        else
            TimeZone="Asia/Tokyo"
        fi
    fi
    
    # 验证时区有效性
    if timedatectl list-timezones 2>/dev/null | grep -q "^$TimeZone$"; then
        echo -ne "[${绿色}完成${原色}] 时区: $TimeZone\n"
    else
        TimeZone="Asia/Shanghai"
        echo -ne "[${黄色}提示${原色}] 时区无效，使用默认值: $TimeZone\n"
    fi
}

# 检查 EFI 支持
function checkEfi() {
    echo -ne "\n${青色}# 检查启动方式${原色}\n"
    
    if [[ -d "/sys/firmware/efi/" ]]; then
        EfiSupport="enabled"
        echo -ne "[${绿色}完成${原色}] UEFI 启动模式\n"
    else
        EfiSupport="disabled"
        echo -ne "[${绿色}完成${原色}] Legacy BIOS 启动模式\n"
    fi
}

# 检查 GRUB
function checkGrub() {
    echo -ne "\n${青色}# 检查引导程序${原色}\n"
    
    GRUBDIR=""
    GRUBFILE=""
    
    # 查找 GRUB 配置文件
    for Count in "/boot/grub/" "/boot/grub2/" "/etc/"; do
        if [[ -f "$Count""grub.cfg" ]] && [[ $(grep -c "menuentry" "$Count""grub.cfg") -ge "1" ]]; then
            GRUBDIR="$Count"
            GRUBFILE="grub.cfg"
            break
        elif [[ -f "$Count""grub.conf" ]] && [[ $(grep -c "menuentry" "$Count""grub.conf") -ge "1" ]]; then
            GRUBDIR="$Count"
            GRUBFILE="grub.conf"
            break
        fi
    done
    
    if [[ -z "$GRUBDIR" ]] || [[ -z "$GRUBFILE" ]]; then
        echo -ne "\n[${红色}错误${原色}] 未找到 GRUB 配置文件！\n"
        exit 1
    fi
    
    # 判断 GRUB 版本
    if [[ -n $(grep -w "grub2-.*" $GRUBDIR/$GRUBFILE) ]] || [[ $(type grub2-mkconfig 2>/dev/null) ]]; then
        GRUBTYPE="isGrub2"
        echo -ne "[${绿色}完成${原色}] GRUB 2\n"
    else
        GRUBTYPE="isGrub1"
        echo -ne "[${绿色}完成${原色}] GRUB 1\n"
    fi
}

# 检查内存
function checkMem() {
    echo -ne "\n${青色}# 检查系统内存${原色}\n"
    
    TotalMem=$(free -m | grep -i "mem:" | awk '{print $2}')
    if [[ -z "$TotalMem" ]]; then
        TotalMem=$(cat /proc/meminfo | grep "^MemTotal:" | awk '{print $2}')
        TotalMem=$(($TotalMem/1024))
    fi
    
    echo -ne "[${绿色}完成${原色}] 总内存: ${TotalMem}MB\n"
    
    # 内存检查
    [[ "$setMemCheck" == '1' ]] && {
        if [[ "$TotalMem" -lt "384" ]]; then
            echo -ne "\n[${红色}错误${原色}] 最低需要 384MB 内存！\n"
            exit 1
        elif [[ "$TotalMem" -lt "512" ]]; then
            echo -ne "[${黄色}警告${原色}] 内存较低，可能会影响安装过程\n"
            lowMemMode="1"
        fi
    }
    
    # 设置 fail2ban 状态
    if [[ "$TotalMem" -lt "1024" ]]; then
        setFail2banStatus="0"
        [[ "$setFail2ban" == "1" ]] && setFail2banStatus="1"
    else
        [[ "$setFail2ban" == "0" ]] && setFail2banStatus="0" || setFail2banStatus="1"
    fi
}

# 检查虚拟化环境
function checkVirt() {
    echo -ne "\n${青色}# 检查虚拟化环境${原色}\n"
    
    virtType=""
    if command -v virt-what &>/dev/null; then
        virtType=$(virt-what 2>/dev/null | head -n1)
    fi
    
    if [[ -z "$virtType" ]]; then
        if [[ -f "/proc/cpuinfo" ]] && grep -q "hypervisor" /proc/cpuinfo; then
            virtType="kvm"
        fi
    fi
    
    [[ -n "$virtType" ]] && echo -ne "[${绿色}完成${原色}] 虚拟化类型: $virtType\n" || echo -ne "[${绿色}完成${原色}] 物理服务器\n"
}

# 系统检查
function checkSys() {
    echo -ne "\n${青色}# 系统环境检查${原色}\n"
    
    # 创建临时交换空间
    if [[ ! -e "/swapspace" ]] && [[ "$TotalMem" -lt "1024" ]]; then
        echo -ne "[${黄色}提示${原色}] 内存较低，创建临时交换空间...\n"
        fallocate -l 512M /swapspace
        chmod 600 /swapspace
        mkswap /swapspace
        swapon /swapspace
    fi
    
    # 更新系统
    if [[ -f /etc/debian_version ]] || [[ -f /etc/lsb-release ]]; then
        apt update -y
        apt install lsb-release curl wget gzip cpio -y
        CurrentOS="Debian"
        [[ -f /etc/lsb-release ]] && CurrentOS="Ubuntu"
    elif [[ -f /etc/redhat-release ]]; then
        yum install epel-release -y
        yum install curl wget gzip cpio -y
        CurrentOS="CentOS"
    else
        echo -ne "\n[${红色}错误${原色}] 不支持的系统！\n"
        exit 1
    fi
    
    echo -ne "[${绿色}完成${原色}] 当前系统: $CurrentOS\n"
}

# 检查架构
function checkVER() {
    echo -ne "\n${青色}# 检查系统架构${原色}\n"
    
    ArchName=$(uname -m)
    case $ArchName in
        arm64) VER="arm64" ;;
        aarch64) VER="aarch64" ;;
        x86|i386|i686) VER="i386" ;;
        x86_64|x86-64|amd64) VER="amd64" ;;
        *) VER="" ;;
    esac
    
    # 处理输入的架构
    if [[ -n "$tmpVER" ]]; then
        case "$tmpVER" in
            i386|i686|x86|32) VER="i386" ;;
            amd64|x86_64|x64|64) VER="amd64" ;;
            aarch64|arm64|arm) VER="arm64" ;;
            *) VER='' ;;
        esac
    fi
    
    if [[ "$VER" != "amd64" && "$VER" != "i386" ]]; then
        echo -ne "\n[${红色}错误${原色}] 仅支持 x86_64 (amd64) 和 i386 架构！\n"
        exit 1
    fi
    
    echo -ne "[${绿色}完成${原色}] 系统架构: $VER\n"
}

# 检查发行版版本
function checkDIST() {
    echo -ne "\n${青色}# 检查发行版版本${原色}\n"
    
    if [[ "$Relese" == 'Debian' ]]; then
        SpikCheckDIST='0'
        DIST="$(echo "$tmpDIST" | sed -r 's/(.*)/\L\1/')"
        DebianDistNum="${DIST}"
        
        # 转换数字版本为代号
        echo "$DIST" | grep -q '[0-9]'
        [[ $? -eq '0' ]] && {
            isDigital="$(echo "$DIST" | grep -o '[\.0-9]\{1,\}' | sed -n '1h;1!H;$g;s/\n//g;$p' | cut -d'.' -f1)"
            [[ -n $isDigital ]] && {
                [[ "$isDigital" == '7' ]] && DIST='wheezy'
                [[ "$isDigital" == '8' ]] && DIST='jessie'
                [[ "$isDigital" == '9' ]] && DIST='stretch'
                [[ "$isDigital" == '10' ]] && DIST='buster'
                [[ "$isDigital" == '11' ]] && DIST='bullseye'
                [[ "$isDigital" == '12' ]] && DIST='bookworm'
            }
        }
        
        LinuxMirror=$(selectMirror "$Relese" "$DIST" "$VER" "$tmpMirror")
        
    elif [[ "$Relese" == 'Ubuntu' ]]; then
        SpikCheckDIST='0'
        DIST="$(echo "$tmpDIST" | sed -r 's/(.*)/\L\1/')"
        echo "$DIST" | grep -q '[0-9]'
        [[ $? -eq '0' ]] && {
            isDigital="$(echo "$DIST" | grep -o '[\.0-9]\{1,\}' | sed -n '1h;1!H;$g;s/\n//g;$p' | cut -d'.' -f1)"
            [[ -n $isDigital ]] && {
                [[ "$isDigital" == '16' ]] && DIST='xenial'
                [[ "$isDigital" == '18' ]] && DIST='bionic'
                [[ "$isDigital" == '20' ]] && DIST='focal'
                [[ "$isDigital" == '22' ]] && DIST='jammy'
            }
        }
        
        LinuxMirror=$(selectMirror "$Relese" "$DIST" "$VER" "$tmpMirror")
    fi
    
    echo -ne "[${绿色}完成${原色}] 发行版: $Relese $DIST\n"
    echo -ne "[${绿色}完成${原色}] 镜像源: $LinuxMirror\n"
}

# 设置 DHCP 或静态网络
function setDhcpOrStatic() {
    if [[ "$1" == "dhcp" || "$1" == "auto" ]]; then
        Network4Config="isDHCP"
        Network6Config="isDHCP"
        echo -ne "[${绿色}完成${原色}] 网络配置: DHCP\n"
    else
        Network4Config="isStatic"
        Network6Config="isStatic"
        echo -ne "[${绿色}完成${原色}] 网络配置: 静态 IP\n"
    fi
}

# 生成 Debian preseed 配置
function DebianModifiedPreseed() {
    if [[ "$linux_relese" == 'debian' ]] || [[ "$linux_relese" == 'ubuntu' ]]; then
        # 基础配置
        AptUpdating="$1 apt update -y;"
        InstallComponents="$1 apt install curl wget vim net-tools -y;"
        
        # 配置 BBR
        [[ "$enableBBR" == "1" ]] && EnableBBR="$1 sed -i '\$anet.core.default_qdisc = fq' $3; $1 sed -i '\$anet.ipv4.tcp_congestion_control = bbr' $3;"
        
        # 时区配置
        SetTimeZone="$1 timedatectl set-timezone $TimeZone;"
        
        # SSH 配置
        SetSSH="$1 sed -ri 's/^#?Port.*/Port ${sshPORT}/g' /etc/ssh/sshd_config; $1 sed -ri 's/^#?PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config; $1 sed -ri 's/^#?PasswordAuthentication.*/PasswordAuthentication yes/g' /etc/ssh/sshd_config; $1 systemctl restart sshd;"
        
        # 主机名
        SetHostname="$1 hostnamectl set-hostname $HostName;"
        
        # 配置 DNS
        [[ "$setDns" == "1" ]] && SetDNS="$1 echo 'nameserver 8.8.8.8' > /etc/resolv.conf; $1 echo 'nameserver 1.1.1.1' >> /etc/resolv.conf;"
        
        # MOTD 配置
        [[ "$setMotd" == "1" ]] && SetMOTD="$1 echo '欢迎使用 $Relese $DIST 系统' > /etc/motd;"
        
        # Fail2Ban 配置
        [[ "$setFail2banStatus" == "1" ]] && {
            EnableFail2ban="$1 apt install fail2ban -y; $1 systemctl enable fail2ban; $1 systemctl start fail2ban;"
        }
        
        export DebianModifiedProcession="${AptUpdating} ${InstallComponents} ${SetTimeZone} ${SetSSH} ${SetHostname} ${SetDNS} ${SetMOTD} ${EnableFail2ban} ${EnableBBR}"
    fi
}

# 生成 preseed 配置
function DebianPreseedProcess() {
    if [[ "$setAutoConfig" == "1" ]]; then
        echo -ne "\n${青色}# 生成自动安装配置${原色}\n"
        
        # 基础配置
        if [[ "$IsCN" == "cn" ]]; then
            debianSecurityMirror="mirrors.tuna.tsinghua.edu.cn"
        else
            debianSecurityMirror="security.debian.org"
        fi
        
        # 网络配置
        if [[ "$Network4Config" == "isStatic" ]]; then
            NetConfigManually=$(echo -e "d-i netcfg/disable_autoconfig boolean true\nd-i netcfg/dhcp_failed note\nd-i netcfg/dhcp_options select 手动配置网络\nd-i netcfg/get_ipaddress string $IPv4\nd-i netcfg/get_netmask string $MASK\nd-i netcfg/get_gateway string $GATE\nd-i netcfg/get_nameservers string $ipDNS\nd-i netcfg/no_default_route boolean true\nd-i netcfg/confirm_static boolean true")
        else
            NetConfigManually=""
        fi
        
        # 分区配置
        if [[ "$EfiSupport" == "enabled" ]]; then
            FormatDisk=$(echo -e "d-i partman-auto/disk string $IncDisk\nd-i partman-auto/method string regular\nd-i partman-auto/choose_recipe select atomic\nd-i partman-partitioning/confirm_write_new_label boolean true\nd-i partman/choose_label string gpt\nd-i partman/confirm boolean true\nd-i partman/confirm_nooverwrite boolean true")
        else
            FormatDisk=$(echo -e "d-i partman-auto/disk string $IncDisk\nd-i partman-auto/method string regular\nd-i partman-auto/choose_recipe select atomic\nd-i partman-partitioning/confirm_write_new_label boolean true\nd-i partman/choose_label string msdos\nd-i partman/confirm boolean true\nd-i partman/confirm_nooverwrite boolean true")
        fi
        
        DebianModifiedPreseed "in-target" "/etc/network/interfaces" "/etc/sysctl.conf"
        
        # 生成 preseed.cfg
        cat >/tmp/boot/preseed.cfg <<EOF
# 自动安装配置
d-i auto-install/enable boolean true
d-i debconf/priority select critical

# 本地化设置
d-i debian-installer/locale string $targetLang
d-i debian-installer/country string CN
d-i debian-installer/language string zh
d-i keyboard-configuration/xkb-keymap string us

# 网络配置
d-i netcfg/choose_interface select $interface
${NetConfigManually}
d-i netcfg/get_hostname string $HostName
d-i netcfg/get_domain string unassigned-domain

# 镜像源设置
d-i mirror/country string manual
d-i mirror/http/hostname string $MirrorHost
d-i mirror/http/directory string $MirrorFolder
d-i mirror/http/proxy string

# 账户设置
d-i passwd/root-login boolean true
d-i passwd/make-user boolean false
d-i passwd/root-password-crypted password ${myPASSWORD}

# 时钟设置
d-i clock-setup/utc boolean true
d-i time/zone string $TimeZone
d-i clock-setup/ntp boolean true

# 分区设置
${FormatDisk}

# 软件包选择
tasksel tasksel/first multiselect standard
d-i pkgsel/include string openssh-server

# GRUB 设置
d-i grub-installer/only_debian boolean true
d-i grub-installer/with_other_os boolean true
d-i grub-installer/bootdev string $IncDisk

# 完成安装
d-i finish-install/reboot_in_progress note

# 后期命令
d-i preseed/late_command string \\
    in-target sed -ri 's/^#?Port.*/Port ${sshPORT}/g' /etc/ssh/sshd_config; \\
    in-target sed -ri 's/^#?PermitRootLogin.*/PermitRootLogin yes/g' /etc/ssh/sshd_config; \\
    in-target sed -ri 's/^#?PasswordAuthentication.*/PasswordAuthentication yes/g' /etc/ssh/sshd_config; \\
    in-target hostnamectl set-hostname $HostName; \\
    in-target timedatectl set-timezone $TimeZone; \\
    in-target echo "欢迎使用 $Relese $DIST 系统" > /etc/motd;
EOF
    fi
}

# 主函数
function main() {
    # 检查系统
    checkSys
    
    # 检查网络位置
    checkCN
    
    # 检查依赖
    dependence "awk,basename,cat,cpio,curl,cut,dirname,file,grep,gzip,ip,lsblk,sed,wget"
    
    # 检查架构
    checkVER
    
    # 检查内存
    checkMem
    
    # 检查虚拟化
    checkVirt
    
    # 检查 EFI
    checkEfi
    
    # 检查 GRUB
    [[ "$loaderMode" == "0" ]] && checkGrub
    
    # 获取发行版信息
    if [[ -n "$Relese" ]]; then
        checkDIST
    else
        Relese='Debian'
        tmpDIST='11'
        checkDIST
    fi
    
    # 获取网络配置
    if [[ -n "$ipAddr" && -n "$ipMask" && -n "$ipGate" ]]; then
        setNet='1'
        setDhcpOrStatic "static"
    else
        getIPv4Address
        setDhcpOrStatic "$tmpDHCP"
    fi
    
    # 获取磁盘信息
    getDisk "$setDisk"
    
    # 获取时区
    getUserTimeZone
    
    # 设置密码
    if [[ -z "$tmpWORD" ]]; then
        tmpWORD='LeitboGi0ro'
        myPASSWORD='$6$qE9Lqgrd0QTOq46i$YMECmKvIw2SeBP4X411I0ZWmtyMsRcBi4Rxu7HYRsqdwqSApi6zjds5UJyM4HrAoBcuLBmjPyLatGydulmCDb0'
    else
        myPASSWORD=$(openssl passwd -6 "$tmpWORD" 2>/dev/null)
        [[ -z "$myPASSWORD" ]] && myPASSWORD=$(openssl passwd -1 "$tmpWORD")
    fi
    
    # 设置 SSH 端口
    [[ -z "$sshPORT" ]] && sshPORT='22'
    
    # 设置主机名
    [[ -z "$tmpHostName" ]] && HostName="server-$(date +%Y%m%d)"
    
    # 显示配置信息
    echo -ne "\n${青色}# 安装配置摘要${原色}\n"
    echo "=========================================="
    echo "操作系统: $Relese $DIST"
    echo "系统架构: $VER"
    echo "启动模式: $EfiSupport"
    echo "网络接口: $interface"
    echo "IP 地址: $ipAddr"
    echo "子网掩码: $ipMask"
    echo "网关地址: $ipGate"
    echo "DNS 服务器: $ipDNS"
    echo "系统磁盘: $IncDisk"
    echo "时区设置: $TimeZone"
    echo "主机名称: $HostName"
    echo "SSH 端口: $sshPORT"
    echo "Root 密码: $tmpWORD"
    echo "启用 BBR: $([ "$enableBBR" == "1" ] && echo "是" || echo "否")"
    echo "自动配置: $([ "$setAutoConfig" == "1" ] && echo "是" || echo "否")"
    echo "=========================================="
    
    # 确认继续
    read -p "按 Enter 键继续安装，或按 Ctrl+C 取消..." </dev/tty
    
    # 下载安装文件
    echo -ne "\n${青色}# 下载系统文件${原色}\n"
    
    if [[ "$Relese" == 'Debian' ]] || [[ "$Relese" == 'Ubuntu' ]]; then
        [[ "$DIST" == "focal" ]] && legacy="legacy-" || legacy=""
        InitrdUrl="${LinuxMirror}/dists/${DIST}/main/installer-${VER}/current/${legacy}images/netboot/${Relese}-installer/${VER}/initrd.gz"
        VmLinuzUrl="${LinuxMirror}/dists/${DIST}/main/installer-${VER}/current/${legacy}images/netboot/${Relese}-installer/${VER}/linux"
        
        echo -ne "下载 initrd.gz... "
        wget --no-check-certificate -qO '/tmp/initrd.img' "$InitrdUrl"
        [[ $? -ne '0' ]] && echo -ne "[${红色}失败${原色}]\n" && exit 1 || echo -ne "[${绿色}成功${原色}]\n"
        
        echo -ne "下载 linux... "
        wget --no-check-certificate -qO '/tmp/vmlinuz' "$VmLinuzUrl"
        [[ $? -ne '0' ]] && echo -ne "[${红色}失败${原色}]\n" && exit 1 || echo -ne "[${绿色}成功${原色}]\n"
        
        MirrorHost="$(echo "$LinuxMirror" | awk -F'://|/' '{print $2}')"
        MirrorFolder="$(echo "$LinuxMirror" | awk -F''${MirrorHost}'' '{print $2}')"
        [ -n "$MirrorFolder" ] || MirrorFolder="/"
    fi
    
    # 解压 initrd
    echo -ne "\n${青色}# 准备安装文件${原色}\n"
    
    [[ -d /tmp/boot ]] && rm -rf /tmp/boot
    mkdir -p /tmp/boot
    cd /tmp/boot
    
    echo -ne "解压 initrd.img... "
    zcat /tmp/initrd.img | cpio -idm >/dev/null 2>&1
    [[ $? -ne '0' ]] && echo -ne "[${红色}失败${原色}]\n" && exit 1 || echo -ne "[${绿色}成功${原色}]\n"
    
    # 生成 preseed 配置
    DebianPreseedProcess
    
    # 重新打包 initrd
    echo -ne "重新打包 initrd.img... "
    find . | cpio -H newc -o | gzip -1 >/tmp/initrd.img.new
    mv /tmp/initrd.img.new /tmp/initrd.img
    echo -ne "[${绿色}成功${原色}]\n"
    
    # 配置 GRUB
    echo -ne "\n${青色}# 配置引导程序${原色}\n"
    
    if [[ "$GRUBTYPE" == "isGrub1" ]]; then
        READGRUB='/tmp/grub.read'
        [[ -f $READGRUB ]] && rm -rf $READGRUB
        
        cp $GRUBDIR/$GRUBFILE "$GRUBDIR/$GRUBFILE.bak.$(date +%Y%m%d%H%M)"
        
        cat $GRUBDIR/$GRUBFILE | sed -n '1h;1!H;$g;s/\n/%%%%%%%/g;$p' | grep -aom 1 'menuentry\ [^{].*{.[^}].*}%%%%%%%' | sed 's/%%%%%%%/\n/g' >$READGRUB
        
        CFG0="$(awk '/menuentry /{print NR}' $READGRUB | head -n 1)"
        CFG2="$(awk '/menuentry /{print NR}' $READGRUB | head -n 2 | tail -n 1)"
        CFG1=""
        
        for tmpCFG in $(awk '/}/{print NR}' $READGRUB); do
            [ "$tmpCFG" -gt "$CFG0" -a "$tmpCFG" -lt "$CFG2" ] && CFG1="$tmpCFG"
        done
        
        [[ -z "$CFG1" ]] && {
            echo -ne "\n[${红色}错误${原色}] 读取 GRUB 配置失败！\n"
            exit 1
        }
        
        sed -n "$CFG0,$CFG1"p $READGRUB >/tmp/grub.new
        
        sed -i "/menuentry.*/c\menuentry\ \'安装 $Relese $DIST\' --class $Relese --class gnu-linux --class gnu --class os \{" /tmp/grub.new
        
        LinuxKernel="$(grep 'linux.*/\|kernel.*/' /tmp/grub.new | awk '{print $1}' | head -n 1)"
        LinuxIMG="$(grep 'initrd.*/' /tmp/grub.new | awk '{print $1}' | tail -n 1)"
        
        # 设置启动参数
        BOOT_OPTION="auto=true hostname=$HostName domain=local"
        [[ "$Network4Config" == "isStatic" ]] && BOOT_OPTION="$BOOT_OPTION netcfg/disable_autoconfig=true netcfg/get_ipaddress=$ipAddr netcfg/get_netmask=$MASK netcfg/get_gateway=$GATE netcfg/get_nameservers=$ipDNS"
        
        sed -i "/$LinuxKernel.*\//c\\\t$LinuxKernel\\t\/boot\/vmlinuz $BOOT_OPTION" /tmp/grub.new
        sed -i "/$LinuxIMG.*\//c\\\t$LinuxIMG\\t\/boot\/initrd.img" /tmp/grub.new
        
        INSERTGRUB="$(awk '/menuentry /{print NR}' $GRUBDIR/$GRUBFILE | head -n 1)"
        
        sed -i ''${INSERTGRUB}'i\\n' $GRUBDIR/$GRUBFILE
        sed -i ''${INSERTGRUB}'r /tmp/grub.new' $GRUBDIR/$GRUBFILE
        
        echo -ne "配置 GRUB... [${绿色}成功${原色}]\n"
        
    elif [[ "$GRUBTYPE" == "isGrub2" ]]; then
        CFG0="$(awk '/insmod part_/{print NR}' $GRUBDIR/$GRUBFILE | head -n 1)"
        CFG2tmp="$(awk '/--fs-uuid --set=root/{print NR}' $GRUBDIR/$GRUBFILE | head -n 2 | tail -n 1)"
        CFG2=$(expr $CFG2tmp + 1)
        CFG1=""
        
        for tmpCFG in $(awk '/fi/{print NR}' $GRUBDIR/$GRUBFILE); do
            [ "$tmpCFG" -ge "$CFG0" -a "$tmpCFG" -le "$CFG2" ] && CFG1="$tmpCFG"
        done
        
        sed -n "$CFG0,$CFG1"p $GRUBDIR/$GRUBFILE >/tmp/grub.new
        
        # 设置启动参数
        BOOT_OPTION="auto=true hostname=$HostName domain=local"
        [[ "$Network4Config" == "isStatic" ]] && BOOT_OPTION="$BOOT_OPTION netcfg/disable_autoconfig=true netcfg/get_ipaddress=$ipAddr netcfg/get_netmask=$MASK netcfg/get_gateway=$GATE netcfg/get_nameservers=$ipDNS"
        
        [[ "$EfiSupport" == "enabled" ]] && BootHex="efi" || BootHex="16"
        
        cat >>/etc/grub.d/40_custom <<EOF
menuentry '安装 $Relese $DIST' --class $Relese --class gnu-linux --class gnu --class os {
  load_video
  set gfxpayload=text
  insmod gzio
$(cat /tmp/grub.new)
  linux$BootHex /boot/vmlinuz $BOOT_OPTION
  initrd$BootHex /boot/initrd.img
}
EOF
        
        grub2-mkconfig -o $GRUBDIR/$GRUBFILE >/dev/null 2>&1
        grub2-set-default "安装 $Relese $DIST" >/dev/null 2>&1
        
        echo -ne "配置 GRUB2... [${绿色}成功${原色}]\n"
    fi
    
    # 复制内核文件
    echo -ne "\n${青色}# 复制内核文件${原色}\n"
    cp -f /tmp/initrd.img /boot/initrd.img
    cp -f /tmp/vmlinuz /boot/vmlinuz
    echo -ne "复制文件... [${绿色}成功${原色}]\n"
    
    # 显示安装信息
    echo -ne "\n${绿色}==========================================${原色}\n"
    echo -ne "${绿色}          安装配置完成！          ${原色}\n"
    echo -ne "${绿色}==========================================${原色}\n"
    echo -ne "\n配置文件位置:\n"
    echo -ne "  GRUB 配置: $GRUBDIR/$GRUBFILE\n"
    echo -ne "  自动安装配置: /tmp/boot/preseed.cfg\n"
    echo -ne "  内核文件: /boot/vmlinuz\n"
    echo -ne "  初始化内存盘: /boot/initrd.img\n"
    echo -ne "\n请重启系统以开始安装:\n"
    echo -ne "  ${黄色}reboot${原色}\n\n"
    echo -ne "系统重启后将自动开始安装 $Relese $DIST\n"
    echo -ne "安装完成后请使用以下信息登录:\n"
    echo -ne "  SSH 地址: ${ipAddr}:${sshPORT}\n"
    echo -ne "  用户名: root\n"
    echo -ne "  密码: ${tmpWORD}\n\n"
}

# 执行主函数
main "$@"
